#!/usr/bin/env bash
#
# Sovereign Stack Manager
# Simple management interface for SSE server + Cloudflare tunnel
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

log_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }

# Check if processes are running
check_sse() {
    ps aux | grep sovereign-sse | grep -v grep | awk '{print $2}'
}

check_tunnel() {
    ps aux | grep "cloudflared tunnel run" | grep -v grep | awk '{print $2}'
}

# Status display
status() {
    echo -e "${CYAN}═══════════════════════════════════════════════════════════════${NC}"
    echo -e "${CYAN}           SOVEREIGN STACK STATUS                              ${NC}"
    echo -e "${CYAN}═══════════════════════════════════════════════════════════════${NC}"
    echo ""

    # SSE Server
    SSE_PID=$(check_sse)
    if [[ -n "$SSE_PID" ]]; then
        echo -e "${GREEN}✓${NC} SSE Server:     RUNNING (PID: $SSE_PID)"
        HEALTH=$(curl -s -m 2 http://localhost:3434/health 2>/dev/null)
        if echo "$HEALTH" | grep -q "healthy"; then
            echo -e "  └─ Health:      ${GREEN}HEALTHY${NC}"
            echo "  └─ Port:        3434"
            echo "  └─ Endpoint:    http://localhost:3434"
        else
            echo -e "  └─ Health:      ${RED}UNHEALTHY${NC}"
        fi
    else
        echo -e "${RED}✗${NC} SSE Server:     NOT RUNNING"
        echo "  └─ Command:     ./scripts/manage start"
    fi
    echo ""

    # Cloudflare Tunnel
    TUNNEL_PID=$(check_tunnel)
    if [[ -n "$TUNNEL_PID" ]]; then
        echo -e "${GREEN}✓${NC} Tunnel:         RUNNING (PID: $TUNNEL_PID)"
        echo "  └─ Hostname:    stack.templetwo.com"
        echo "  └─ Target:      http://localhost:3434"
        REMOTE=$(curl -s -m 3 https://stack.templetwo.com/health 2>/dev/null)
        if echo "$REMOTE" | grep -q "healthy"; then
            echo -e "  └─ Remote:      ${GREEN}ACCESSIBLE${NC}"
        else
            echo -e "  └─ Remote:      ${YELLOW}UNREACHABLE (503)${NC}"
        fi
    else
        echo -e "${RED}✗${NC} Tunnel:         NOT RUNNING"
        echo "  └─ Command:     ./scripts/manage start"
    fi
    echo ""

    # Data status
    if [[ -d ~/.sovereign/chronicle ]]; then
        INSIGHT_FILES=$(find ~/.sovereign/chronicle/insights -name "*.jsonl" -type f 2>/dev/null | wc -l | tr -d ' ')
        DOMAINS=$(find ~/.sovereign/chronicle/insights -type d -depth 1 2>/dev/null | wc -l | tr -d ' ')
        echo -e "${GREEN}✓${NC} Chronicle:      READY"
        echo "  └─ Domains:     $DOMAINS"
        echo "  └─ Insights:    $INSIGHT_FILES files"
    fi

    echo -e "${CYAN}═══════════════════════════════════════════════════════════════${NC}"
}

# Start services
start() {
    log_info "Starting sovereign-stack services..."
    echo ""

    # Start SSE server
    if [[ -z "$(check_sse)" ]]; then
        log_info "Starting SSE server..."
        nohup "$PROJECT_ROOT/venv/bin/sovereign-sse" > ~/.sovereign/sse.log 2>&1 &
        sleep 2
        if [[ -n "$(check_sse)" ]]; then
            log_info "SSE Server started (PID: $(check_sse))"
        else
            log_error "SSE Server failed to start - check ~/.sovereign/sse.log"
            return 1
        fi
    else
        log_warn "SSE Server already running (PID: $(check_sse))"
    fi

    # Start tunnel
    if [[ -z "$(check_tunnel)" ]]; then
        log_info "Starting Cloudflare tunnel..."
        nohup cloudflared tunnel run sovereign-stack > ~/.sovereign/tunnel.log 2>&1 &
        sleep 3
        if [[ -n "$(check_tunnel)" ]]; then
            log_info "Tunnel started (PID: $(check_tunnel))"
        else
            log_error "Tunnel failed to start - check ~/.sovereign/tunnel.log"
            return 1
        fi
    else
        log_warn "Tunnel already running (PID: $(check_tunnel))"
    fi

    echo ""
    status
}

# Stop services
stop() {
    log_info "Stopping sovereign-stack services..."
    echo ""

    SSE_PID=$(check_sse)
    if [[ -n "$SSE_PID" ]]; then
        kill $SSE_PID
        log_info "SSE Server stopped (PID: $SSE_PID)"
    else
        log_warn "SSE Server not running"
    fi

    TUNNEL_PID=$(check_tunnel)
    if [[ -n "$TUNNEL_PID" ]]; then
        kill $TUNNEL_PID
        log_info "Tunnel stopped (PID: $TUNNEL_PID)"
    else
        log_warn "Tunnel not running"
    fi

    sleep 2
    echo ""
    status
}

# Restart services
restart() {
    log_info "Restarting sovereign-stack services..."
    echo ""
    stop
    sleep 2
    start
}

# Show logs
logs() {
    case "$1" in
        sse)
            echo "Tailing SSE server logs (Ctrl+C to exit)..."
            tail -f ~/.sovereign/sse.log
            ;;
        tunnel)
            echo "Tailing tunnel logs (Ctrl+C to exit)..."
            tail -f ~/.sovereign/tunnel.log
            ;;
        *)
            echo "Usage: $0 logs [sse|tunnel]"
            echo ""
            echo "Available logs:"
            echo "  sse    - SSE server logs (~/.sovereign/sse.log)"
            echo "  tunnel - Cloudflare tunnel logs (~/.sovereign/tunnel.log)"
            ;;
    esac
}

# Health check with retry
health() {
    echo "Running health checks..."
    echo ""

    # Check SSE
    echo -n "SSE Server (localhost:3434): "
    if HEALTH=$(curl -s -m 2 http://localhost:3434/health 2>/dev/null); then
        if echo "$HEALTH" | grep -q "healthy"; then
            echo -e "${GREEN}HEALTHY${NC}"
            echo "$HEALTH" | python3 -m json.tool 2>/dev/null || echo "$HEALTH"
        else
            echo -e "${RED}UNHEALTHY${NC}"
            echo "$HEALTH"
        fi
    else
        echo -e "${RED}UNREACHABLE${NC}"
    fi
    echo ""

    # Check tunnel
    echo -n "Remote (stack.templetwo.com): "
    if REMOTE=$(curl -s -m 5 https://stack.templetwo.com/health 2>/dev/null); then
        if echo "$REMOTE" | grep -q "healthy"; then
            echo -e "${GREEN}ACCESSIBLE${NC}"
        else
            echo -e "${YELLOW}REACHABLE BUT UNHEALTHY${NC}"
        fi
    else
        echo -e "${YELLOW}UNREACHABLE (503)${NC}"
    fi
}

# Main command handler
case "${1:-status}" in
    start)
        start
        ;;
    stop)
        stop
        ;;
    restart)
        restart
        ;;
    status)
        status
        ;;
    logs)
        logs "${2:-}"
        ;;
    health)
        health
        ;;
    *)
        echo "Sovereign Stack Manager"
        echo ""
        echo "Usage: $0 {start|stop|restart|status|health|logs [sse|tunnel]}"
        echo ""
        echo "Commands:"
        echo "  start    - Start SSE server and Cloudflare tunnel"
        echo "  stop     - Stop all services"
        echo "  restart  - Restart all services"
        echo "  status   - Show service status (default)"
        echo "  health   - Run health checks with details"
        echo "  logs     - Tail service logs"
        exit 1
        ;;
esac
